"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _possibleConstructorReturn(e,t){return!t||"object"!==_typeof(t)&&"function"!=typeof t?_assertThisInitialized(e):t}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _get(e,t,i){return(_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,i){var n=_superPropBase(e,t);if(n){var s=Object.getOwnPropertyDescriptor(n,t);return s.get?s.get.call(i):s.value}})(e,t,i||e)}function _superPropBase(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=_getPrototypeOf(e)););return e}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function _instanceof(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?t[Symbol.hasInstance](e):e instanceof t}function _classCallCheck(e,t){if(!_instanceof(e,t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,i){return t&&_defineProperties(e.prototype,t),i&&_defineProperties(e,i),e}var Happy=function(){function t(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,t),this.baseClasses={item:HappyItem,document:HappyDocument,form:HappyForm,field:HappyField,input:HappyInput},this.cleaners={},this.validators={},this.customClasses={documents:{},forms:{},fields:{},inputs:{}},this.initVars(),this.extend(e),window.Happy.instance=this}return _createClass(t,[{key:"initVars",value:function(){this.items=[],this.inputs=[],this.fields=[],this.forms=[],this.documents=[],this.topLevelItems=[],this.currentField=void 0,this.nextId=1}},{key:"extend",value:function(e){var t=0<arguments.length&&void 0!==e?e:{};return Object.assign(this,t)}},{key:"getClass",value:function(e,t){var i,n=e+"s";return t&&(i=this.customClasses[n][t]),i||this.baseClasses[e]}},{key:"guessElementHappyType",value:function(e){return"form"===e.nodeName.toLowerCase()?"form":"document"}},{key:"addItem",value:function(e,t){var i=1<arguments.length&&void 0!==t?t:{},n=e+"s",s=i.type,r=i.CustomClass||this.getClass(e,s);delete i.CustomClass,delete i.type;var a=new r(i,this);return s&&(a[e+"Type"]=s),a.isTopLevel&&this.topLevelItems.push(a),this[n]&&this[n].push(a),this.items.push(a),a}},{key:"find",value:function(e,t){var i,n=1<arguments.length&&void 0!==t?t:this.items,s=0,r=n.length;if(r){for(;!i&&s<r;){var a=n[s];a.id!==e&&a.name!==e||(i=a),s++}return i}}},{key:"focusUnhappy",value:function(e){var t=document.querySelector(e||".unhappy > input");t&&t.focus()}},{key:"mount",value:function(e){var t=0<arguments.length&&void 0!==e?e:{};if(!t.el)throw new Error("A mount element is required!");if(!this.items.length){var i=t.type;i?delete t.type:i=this.guessElementHappyType(t.el);var n=this.addItem(i,t);return n.mount(),n}this.topLevelItems.forEach(function(e){return e.mount()})}},{key:"dismount",value:function(){this.topLevelItems.forEach(function(e){return e.dismount()}),this.initVars()}}]),t}(),HappyRule=function e(t){_classCallCheck(this,e);var i=t.split(":");this.name=i.shift(),this.args=i,this.arg=i.length?i[0]:void 0},HappyItem=function(){function n(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},i=2<arguments.length?arguments[2]:void 0;_classCallCheck(this,n),this.el=t.el,this.parent=t.parent,this.happyType=e,delete t.parent,delete t.el,this.options=t,this.happy$=i,this.parent||(this.isTopLevel=!0),this.name=this.options.name,this.id=this.options.id||this.extractId(),this.mounted=!1,this.children=[],this.happy=!0,this.nextId=1}return _createClass(n,[{key:"rateLimit",value:function(e,t,i,n){var s=(new Date).getTime();s-(e.lastUpdated||0)>n&&(e.lastUpdated=s,t.apply(e,i))}},{key:"ignoreBlur",value:function(){return this.isType(["checkbox","checklist","radiolist","select","file"])}},{key:"setOpt",value:function(e,t,i){void 0===this.options[e]&&(this.options[e]=void 0!==t?t:i)}},{key:"getOpt",value:function(e,t){return this.options[e]?this.options[e]:this.parent?this.parent.getOpt(e,t):t}},{key:"isType",value:function(e){var t=this.happyType+"Type";return"string"==typeof e&&(e=[e]),e.includes(this[t])}},{key:"isModified",value:function(){if("input"===this.happyType)return this.value!==this.initialValue;for(var e=0,t=this.children.length;e<t;e++)if(this.children[e].isModified())return!0;return!1}},{key:"isHappy",value:function(){if("input"===this.happyType)return this.happy;for(var e=0,t=this.children.length;e<t;e++)if(!this.children[e].happy)return!1;return!0}},{key:"getDomElement",value:function(){return this.el?this.el:this.options.selector?(this.parent?this.parent.el:document.body).querySelector(this.options.selector):void 0}},{key:"getValue",value:function(e){var t=this.extractValue(),i=this.clean(t);return e&&(this.initialValue=i),i}},{key:"extractId",value:function(){var e;switch(this.happyType){case"input":e="i";break;case"field":e="f";break;case"document":e="doc";break;default:e=this.happyType}return this.parent&&this.parent.nextId?this.parent.id+"_"+e+this.parent.nextId++:e+this.happy$.nextId++}},{key:"extractType",value:function(){return this.inputs.length?this.inputs[0].inputType:"text"}},{key:"extractName",value:function(){return this.el.getAttribute("data-name")||this.el.name||this.el.id}},{key:"extractLabel",value:function(){return this.el.getAttribute("data-label")}},{key:"extractValue",value:function(){var e;switch(this.inputType){case"radio":case"checkbox":e=this.el.checked?this.el.value||1:"";break;case"option":e=this.el.selected?this.el.value||1:"";break;default:e=this.el.value}return e}},{key:"extractRules",value:function(){var i=this;this.rules=this.rules||{};var e=this.el.getAttribute("data-validate");(e?e.split("|"):[]).forEach(function(e){var t=new HappyRule(e);i.rules[t.name]=t}),!this.rules.required&&this.el.hasAttribute("required")&&(this.rules.required=new HappyRule("required")),!this.rules.required&&this.el.classList.contains("required")&&(this.rules.required=new HappyRule("required"))}},{key:"extractCleaners",value:function(){var e=this.el.getAttribute("data-format");e&&(this.cleaners=e.split("|"))}},{key:"clean",value:function(e){if(!e)return e;var t=e.trim();if(!this.cleaners)return t;for(var i=0,n=this.cleaners.length;i<n;i++){var s=this.happy$.cleaners[this.cleaners[i]];s&&(t=s.call(this,t))}return t}},{key:"getNext",value:function(e){if(!this.isTopLevel){var t=this.parent,i=t.children.length;if(i<2){if(t.isTopLevel)return;var n=t.getNext();if(n&&n.children.length)return n.children[0]}var s=t.children.indexOf(this)+1;if(i<=s){if(e){var r=t.getNext();if(r&&r.children.length)return r.children[0]}return t.children[0]}return t.children[s]}}},{key:"getPrev",value:function(e){if(!this.isTopLevel){var t=this.parent.children.length;if(!(t<2)){var i=this.parent.children.indexOf(this);if(i)return this.parent.children[i-1];if(e){var n=this.parent.getPrev();if(n&&n.children.length)return n.children[n.children.length-1]}return this.parent.children[t-1]}}}},{key:"validate",value:function(e,t){var i=[],n=this.getOpt("validate");if(this.happy=!0,n)i=n(e,t);else{var s=this.happy$;if(this.subValidateInputs){for(var r=[],a=0,l=this.inputs.length;a<l;a++){var u=this.inputs[a];for(var o in u.rules)if(u.rules.hasOwnProperty(o)){r.push(u);break}}for(var h=0,p=r.length;h<p;h++){var c=!0,f=this.inputs[h];for(var d in f.rules){var y=f.rules[d],v=s.validators[y.name];if(v){var m=v.call(f,y,t);m&&("required"===y.name?i.unshift({item:f,message:m}):i.push({item:f,message:m}),c=!1,this.happy=!1)}}f.happy=c}}for(var g in this.rules){var k=this.rules[g],b=s.validators[k.name];if(b){var _=b.call(this,k,t);_&&("required"===k.name?i.unshift({item:this,message:_}):i.push({item:this,message:_}),this.happy=!1)}}}return i}},{key:"bindEvents",value:function(){this.isTopLevel&&(this.el.addEventListener("focus",this.onFocusHandler,!0),this.el.addEventListener("blur",this.onBlurHandler,!0),this.el.addEventListener("change",this.onChangeHandler,!0),this.el.addEventListener("keydown",this.onKeyDownHandler,!0),this.el.addEventListener("submit",this.onSubmitHandler,!0))}},{key:"unbindEvents",value:function(){this.isTopLevel&&(this.el.removeEventListener("submit",this.onSubmitHandler,!0),this.el.removeEventListener("keydown",this.onKeyDownHandler,!0),this.el.removeEventListener("change",this.onChangeHandler,!0),this.el.removeEventListener("blur",this.onBlurHandler,!0),this.el.removeEventListener("focus",this.onFocusHandler,!0))}},{key:"onFocusHandler",value:function(e){var t=e.target.HAPPY;if(t&&"input"===t.happyType){var i=t.parent,n=t.happy$;if(i===n.currentField&&i.ignoreBlur())return clearTimeout(i.delayBlurEventTimer);n.currentField=i}}},{key:"onBlurHandler",value:function(e){var t=e.target.HAPPY;if(t&&"input"===t.happyType){var i=t.parent;i.delayBlurEventTimer=setTimeout(function(){i.rateLimit(i,i.update,[e,"onBlur"],150)})}}},{key:"onChangeHandler",value:function(e){var t=e.target.HAPPY;if(t&&"input"===t.happyType){var i=t.parent;i.rateLimit(i,i.update,[e,"onChange"],150)}}},{key:"onKeyDownHandler",value:function(e){var t=e.target.HAPPY;if(t&&"input"===t.happyType){var i=t.parent;if("Enter"===e.key||13==e.when||13==e.keyCode){if(i.isType("memo"))return;var n;if(e.stopImmediatePropagation(),e.preventDefault(),i.isType(["checkbox","checklist","radiolist"])&&t.el.click(),"radiolist"===i.fieldType){var s=i.getNext(!0);s&&(n=s.inputs[0])}else n=t.getNext(!0);n&&n.el.focus()}else if("ArrowDown"===e.key&&i.isType("checklist")){var r=t.getNext();r&&r.el.focus()}else if("ArrowUp"===e.key&&i.isType("checklist")){var a=t.getPrev();a&&a.el.focus()}}}},{key:"onSubmitHandler",value:function(e){F1.console.log("HappyItem::onSubmitHandler()",e),e.target.HAPPY.update(e,"onSubmit"),this.happy||(e.preventDefault(),e.stopPropagation())}},{key:"removeMessages",value:function(){var e=this.el,t="."+this.getOpt("messageGroupClass","messages");e.querySelectorAll(t).forEach(function(e){return e.parentElement.removeChild(e)}),this.inputs.forEach(function(e){return e.messages=[]}),this.messages=[]}},{key:"addMessages",value:function(e){for(var t,i,n,s,r,a=this.getOpt("messageGroupClass","messages"),l=this.getOpt("messageClass","message error"),u=0,o=e.length;u<o;u++)(r=(s=e[u]).item||this).messages=r.messages||[],r.elMsgGrp||((i=document.createElement("li")).className=l,(n="input"===r.happyType?r.el.parentElement:r.el.querySelector(".input-group"))||(n=r.el),r.elMsgGrp||(r.elMsgGrp=document.createElement("ul"),r.elMsgGrp.className=a,n.appendChild(r.elMsgGrp)),t=s.message,i.innerHTML=t,r.elMsgGrp.appendChild(i),r.messages.push({el:i,elParent:n,text:t}));for(var h=0,p=e.length;h<p;h++)(s=e[h]).item&&delete s.item.elMsgGrp;delete this.elMsgGrp}},{key:"renderState",value:function(){var e=this.getOpt("happyClass","happy"),t=this.getOpt("unhappyClass","unhappy"),i="input"===this.happyType?this.el.parentElement:this.el;this.isHappy()?(i.classList.add(e),i.classList.remove(t)):(i.classList.add(t),i.classList.remove(e));var n=this.getOpt("modifiedClass","modified");this.modified?i.classList.add(n):i.classList.remove(n)}},{key:"render",value:function(){return document.createElement("div")}},{key:"update",value:function(e,t){if(this.value=this.getValue(),this.modified=this.isModified(),"isParent"===t)this.happy=this.isHappy();else{var i=this.validate(e,t)||[];this.removeMessages(),this.addMessages(i);for(var n=0,s=this.inputs.length;n<s;n++){var r=this.inputs[n];r.modified=r.isModified(),r.renderState()}}this.renderState(),this.isTopLevel||this.parent.update(e,"isParent")}},{key:"mount",value:function(e){var t=0<arguments.length&&void 0!==e?e:{};if(!this.mounted){var i=this.parent||{},n=t.appendTo;this.el=this.el||this.getDomElement()||t.el,this.el||(n||(n=i.el||document.body),this.el=this.render(),n.append(this.el),this.isRenderedElement=!0),(this.el.HAPPY=this).isTopLevel&&F1.console.log("Happy[",this.happyType,"]::mount() - ok",this),this.mounted=!0,this.bindEvents()}}},{key:"dismount",value:function(){this.el&&this.isRenderedElement?(this.el.parentElement.removeChild(this.el),this.el=void 0):this.el&&delete this.el.HAPPY,this.children&&(this.children.forEach(function(e){return e.dismount()}),this.children=void 0),this.nextId=1,this.mounted=!1,this.isRenderedElement||this.unbindEvents()}}]),n}(),HappyInput=function(){function n(e,t){return _classCallCheck(this,n),_possibleConstructorReturn(this,_getPrototypeOf(n).call(this,"input",e,t))}return _inherits(n,HappyItem),_createClass(n,[{key:"extractLabel",value:function(){var e=this.el.previousElementSibling;if(e&&"LABEL"===e.nodeName)return e.innerHTML.replace(/\s*:$/,"")}},{key:"extractRules",value:function(){if(_get(_getPrototypeOf(n.prototype),"extractRules",this).call(this),this.el.hasAttribute("min")){var e=this.el.getAttribute("min");this.rules.min=new HappyRule("min:"+e)}if(this.el.hasAttribute("max")){var t=this.el.getAttribute("max");this.rules.max=new HappyRule("max:"+t)}if(this.el.hasAttribute("pattern")){var i=this.el.getAttribute("pattern");this.rules.pattern=new HappyRule("pattern:"+i)}}},{key:"mount",value:function(e){_get(_getPrototypeOf(n.prototype),"mount",this).call(this,e),this.extractRules(),this.extractCleaners(),this.value=this.getValue("init"),this.name=this.extractName(),this.label=this.extractLabel()}}]),n}(),HappyField=function(){function i(e,t){return _classCallCheck(this,i),_possibleConstructorReturn(this,_getPrototypeOf(i).call(this,"field",e,t))}return _inherits(i,HappyItem),_createClass(i,[{key:"getValue",value:function(e){for(var t=[],i=0,n=this.inputs.length;i<n;i++){var s=this.inputs[i];s.value=s.getValue(e),!s.value&&0!==s.value||t.push(s.value)}var r=t.join(",");return e&&(this.initialValue=r),r}},{key:"extractName",value:function(){return 1===this.inputs.length?this.inputs[0].name:this.el.getAttribute("data-name")||this.el.id}},{key:"extractInputType",value:function(e){return e.getAttribute("data-type")||e.type}},{key:"extractInputs",value:function(){var e=this;e.inputs=[];for(var t=e.getOpt("inputSelector",'input:not(hidden):not([type="submit"]), textarea, select'),i=e.el.querySelectorAll(t),n=0,s=i.length;n<s;n++){var r=i[n],a=e.extractInputType(r),l=e.happy$.addItem("input",{el:r,type:a,parent:e});e.inputs.push(l)}e.children=e.inputs}},{key:"mount",value:function(e){_get(_getPrototypeOf(i.prototype),"mount",this).call(this,e),this.extractRules(),this.extractCleaners(),this.extractInputs(),this.inputs.forEach(function(e){return e.mount()}),this.fieldType=this.fieldType||this.extractType(),this.value=this.getValue("init"),this.name=this.extractName(),this.label=this.extractLabel()}},{key:"dismount",value:function(){_get(_getPrototypeOf(i.prototype),"dismount",this).call(this),this.inputs=void 0}}]),i}(),HappyForm=function(){function i(e,t){return _classCallCheck(this,i),_possibleConstructorReturn(this,_getPrototypeOf(i).call(this,"form",e,t))}return _inherits(i,HappyItem),_createClass(i,[{key:"getValue",value:function(){for(var e={},t=0,i=this.fields.length;t<i;t++){var n=this.fields[t];e[n.name||n.id]=n.value}return e}},{key:"extractFieldType",value:function(e){return e.getAttribute("data-type")}},{key:"extractFields",value:function(){var e=this;e.fields=[];for(var t=e.getOpt("fieldSelector",".field"),i=e.el.querySelectorAll(t),n=0,s=i.length;n<s;n++){var r=i[n],a=e.extractFieldType(r),l=e.happy$.addItem("field",{el:r,type:a,parent:e});e.fields.push(l)}e.children=e.fields}},{key:"mount",value:function(e){_get(_getPrototypeOf(i.prototype),"mount",this).call(this,e),this.extractFields(),this.fields.forEach(function(e){return e.mount()})}},{key:"dismount",value:function(){_get(_getPrototypeOf(i.prototype),"dismount",this).call(this),this.fields=void 0}}]),i}(),HappyDocument=function(){function i(e,t){return _classCallCheck(this,i),_possibleConstructorReturn(this,_getPrototypeOf(i).call(this,"document",e,t))}return _inherits(i,HappyItem),_createClass(i,[{key:"extractFormType",value:function(e){return e.getAttribute("data-type")}},{key:"extractForms",value:function(){var e=this;e.forms=[];for(var t=e.getOpt("formSelector","form"),i=e.el.querySelectorAll(t),n=0,s=i.length;n<s;n++){var r=i[n],a=e.extractFormType(r),l=e.happy$.addItem("form",{el:r,type:a,parent:e});e.forms.push(l)}e.children=e.forms}},{key:"mount",value:function(e){_get(_getPrototypeOf(i.prototype),"mount",this).call(this,e),this.extractForms(),this.forms.forEach(function(e){return e.mount()})}},{key:"dismount",value:function(){_get(_getPrototypeOf(i.prototype),"dismount",this).call(this),this.forms=void 0}}]),i}();window.Happy=Happy;